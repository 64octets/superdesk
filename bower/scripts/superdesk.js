!function(){"use strict";function a(a,b){angular.extend(a,_.pick(b,i))}function b(b,c,d){var e,f="archive_autosave",g=3e3;this.open=function(c){return c._locked?b.when(c):d.find(f,c._id).then(function(b){return a(c,b),c._autosave=b,c},function(){return c})},this.save=function(b,h){return this.stop(),e=c(function(){var c=angular.extend({_id:b._id},h);return d.save(f,{},c).then(function(c){b._autosave=c,a(b._autosave,h),a(b,h)})},g)},this.stop=function(){e&&(c.cancel(e),e=null)},this.drop=function(a){c.cancel(e),d(f).remove(a._autosave),a._autosave=null}}function c(a,b,c,d,e){return console.time("item"),b.find("archive",a.current.params._id).then(function(a){return console.time("lock"),c.lock(a)}).then(function(a){return console.timeEnd("lock"),console.time("autosave"),d.open(a)}).then(function(a){return e.setActive(a),console.timeEnd("lock"),console.timeEnd("autosave"),console.timeEnd("item"),a})}function d(a,b,c){this.lock=function(d){return d.lock_user?(d._locked=d.lock_user!==c.identity._id||d.lock_session!==c.sessionId,a.when(d)):b("archive_lock",d).save({}).then(function(a){return _.extend(d,a),d._locked=!1,d.lock_user=c.identity.id,d.lock_session=c.sessionId,d},function(){return d._locked=!0,d})},this.unlock=function(a){return b("archive_unlock",a).save({}).then(function(b){return _.extend(a,b),a._locked=!0,a},function(){return a._locked=!0,a})},this.isLocked=function(a){return a.lock_user&&a.lock_session&&(a.lock_user!==c.identity._id||a.lock_session!==c.sessionId)},this.isLockedByMe=function(a){return a.lock_user&&a.lock_session&&a.lock_user===c.identity._id&&a.lock_session!==c.sessionId}}function e(a,b,c,d){return function(e){function f(){return c.confirm(d("There are unsaved changes. Please confirm you want to close the article without saving."))}a.onbeforeunload=function(){return e.dirty?d("There are unsaved changes. If you navigate away, your changes will be lost."):void 0},e.$on("$destroy",function(){a.onbeforeunload=angular.noop}),this.confirm=function(){return e.dirty?f():b.when()}}}function f(b,c,d,e,f,g,h,i,j,k){function l(){function a(){var a=!1;return angular.forEach(b.item,function(b,c){a=a||b!==j[c]}),a}m(),m=b.$watchGroup(["item.headline","item.slugline","item.body_html"],function(){b.dirty=a(),b.dirty&&b.isEditable()&&(b.saving=!0,k.save(j,b.item).then(function(){b.saving=!1}))})}var m=angular.noop;b.workqueue=e.all(),b.saving=!1,b.saved=!1,b.dirty=!1,b.viewSendTo=!1,b.isEditable=function(){return!b._preview&&!b.item._locked},b.save=function(){return m(),k.stop(),d.save("archive",j,b.item).then(function(){return e.update(j),j._autosave=null,b.dirty=!1,b.saving=!1,b.item=_.create(j),f.success(g("Item updated.")),l(),j},function(){f.error(g("Error. Item not updated."))})},b.close=function(){b._editable&&h.unlock(b.item),b.dirty=!1,e.remove(b.item),c.intent("author","dashboard")},b.preview=function(c){m(),a(b.item,c),b._preview=!0,b._editable=!1},b.revert=function(c){return a(b.item,c),b.save()},b.closePreview=function(){b.item=_.create(j),a(b.item,j._autosave||{}),b._preview=!1,b._editable=b.isEditable(),b._editable&&l()},b.dropAutosave=function(b){k.drop(j),a(j,b)},b.closePreview()}function g(){return{link:function(a,b){var c=b.parent(),d=c.parent().width(),e=parseInt(b.css("margin-left"),10)+parseInt(b.css("margin-right"),10),f=c.outerWidth()+b.outerWidth()+e;d>f&&c.outerWidth(f)}}}function h(a,b,c,d,e){return{scope:{item:"=",view:"=",_beforeSend:"=beforeSend"},templateUrl:"scripts/superdesk-authoring/views/send-item.html",link:function(f){function g(a){f.beforeSend().then(function(){c.save("tasks",f.task,a).then(h)})}function h(){e.success(gettext("Item sent.")),b.intent("author","dashboard")}f.desk=null,f.desks=null,f.stages=null,f.beforeSend=f._beforeSend||a.when;var i=function(){return c.find("tasks",f.item._id).then(function(a){f.task=a}).then(function(){d.initialize().then(function(){f.desks=d.desks,f.item.task&&f.item.task.desk&&(f.desk=d.deskLookup[f.item.task.desk])})})},j=function(){d.initialize().then(function(){f.desks=d.desks,f.item.task&&f.item.task.desk&&(f.desk=d.deskLookup[f.item.task.desk]),f.desk&&c("stages").query({where:{desk:f.desk._id}}).then(function(a){f.stages=a})})};f.$watch("item",function(){i().then(function(){j()})}),f.sendToDesk=function(a){g({task:_.extend(f.task.task,{desk:a._id,stage:a.incoming_stage||null})})},f.sendToStage=function(a){g({task:_.extend(f.task.task,{stage:a._id})})}}}}var i=["headline","slugline","body_html"];return b.$inject=["$q","$timeout","api"],c.$inject=["$route","api","lock","autosave","workqueue"],d.$inject=["$q","api","session"],e.$inject=["$window","$q","modal","gettext"],f.$inject=["$scope","superdesk","api","workqueue","notify","gettext","lock","desks","item","autosave"],h.$inject=["$q","superdesk","api","desks","notify"],angular.module("superdesk.authoring",["superdesk.editor","superdesk.activity","superdesk.authoring.widgets","superdesk.authoring.metadata","superdesk.authoring.comments","superdesk.authoring.versions","superdesk.authoring.workqueue","superdesk.desks"]).service("lock",d).service("autosave",b).factory("ConfirmDirty",e).directive("sdDashboardCard",g).directive("sdSendItem",h).config(["superdeskProvider",function(a){a.activity("authoring",{when:"/authoring/:_id",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",controller:f,filters:[{action:"author",type:"article"}],resolve:{item:c}}).activity("edit.text",{label:gettext("Edit item"),icon:"pencil",controller:["data","$location","workqueue","superdesk",function(a,b,c,d){c.add(a.item),d.intent("author","article",a.item)}],filters:[{action:a.ACTION_EDIT,type:"archive"}]})}])}(),function(){"use strict";function a(){var a=[];this.widget=function(b,c){a.push(angular.extend({},c,{_id:b}))},this.$get=function(){return a}}function b(a,b,c){a.active=null,a.widgets=c,a.activate=function(b){a.active=a.active===b?null:b},angular.forEach(a.widgets,function(c){b[c._id]&&a.activate(c)})}function c(){return{controller:b,templateUrl:"scripts/superdesk-authoring/widgets/views/authoring-widgets.html",transclude:!0}}b.$inject=["$scope","$routeParams","authoringWidgets"],angular.module("superdesk.authoring.widgets",[]).provider("authoringWidgets",a).directive("sdAuthoringWidgets",c)}(),function(){"use strict";function a(a){this.comments=null,this.fetch=function(b){var c={where:{item:b},embedded:{user:1}};return a.item_comments.query(c).then(angular.bind(this,function(a){this.comments=a._items}))},this.save=function(b){return a.item_comments.save(b)}}function b(a,b,c){function e(){a.item&&c.fetch(a.item._id).then(function(){a.comments=c.comments})}function f(){a.active=b.comments||null}a.text=null,a.saveEnterFlag=!1,a.$watch("item._id",e),a.users=[],a.saveOnEnter=function(b){a.saveEnterFlag&&b.keyCode===d&&!b.shiftKey&&a.save()},a.save=function(){var b=a.text||"";b.length&&(a.text="",a.flags={saving:!0},c.save({text:b,item:a.item._id}).then(e))},a.cancel=function(){a.text=""},a.$on("item:comment",function(b,c){c.item===a.item.guid&&e()}),a.$on("$locationChangeSuccess",f),f()}function c(a){return{scope:{comment:"="},link:function(b,c,d){var e;e=d.text.replace(/(?:\r\n|\r|\n)/g,"</p><p>");var f=e.match(/\@([a-zA-Z0-9-_.]\w+)/g);_.each(f,function(a){var c=a.substring(1,a.length);b.comment.mentioned_users&&b.comment.mentioned_users[c]&&(e=e.replace(a,'<i sd-user-info data-user="'+b.comment.mentioned_users[c]+'">'+a+"</i>"))}),c.html("<p><b>"+d.name+"</b> : "+e+"</p>"),a(c.contents())(b)}}}var d=13;a.$inject=["api"],b.$inject=["$scope","$routeParams","commentsService","api","$q"],c.$inject=["$compile"],angular.module("superdesk.authoring.comments",["superdesk.authoring.widgets","mentio","superdesk.api"]).config(["authoringWidgetsProvider",function(a){a.widget("comments",{icon:"comments",label:gettext("Comments"),template:"scripts/superdesk-authoring/comments/views/comments-widget.html"})}]).config(["apiProvider",function(a){a.api("item_comments",{type:"http",backend:{rel:"item_comments"}})}]).controller("CommentsWidgetCtrl",b).service("commentsService",a).directive("sdCommentText",c)}(),function(){"use strict";function a(a,b){function c(c){b.users.getById(c).then(function(b){a.users[c]=b})}function d(){return b.archive.getByUrl(a.item._links.self.href+'?version=all&embedded={"user":1}').then(function(b){_.each(b._items,function(b){var d=b.creator||b.original_creator;d&&!a.users[d]&&c(d)}),a.versions=b,a.selected=a.item._autosave?a.item._autosave:e(),a.last=e()})}function e(){return a.item._latest_version?_.find(a.versions._items,{_version:a.item._latest_version}):_.max(a.versions._items,function(a){return a._version||a.version||a._updated})}a.last=null,a.versions=null,a.selected=null,a.users={},a.openAutosave=function(){a.selected=a.item._autosave,a.closePreview()},a.openVersion=function(b){a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview()},a.revert=function(b){a.last===b?(a.dropAutosave(b),a.openVersion(b)):a.$parent.revert(b).then(d)},a.$watchGroup(["item._id","item._latest_version"],d)}a.$inject=["$scope","api","$location","notify","workqueue","lock"],angular.module("superdesk.authoring.versions",[]).config(["authoringWidgetsProvider",function(a){a.widget("versions",{icon:"revision",label:gettext("Versions"),template:"scripts/superdesk-authoring/versioning/views/versions.html"})}]).controller("VersioningWidgetCtrl",a)}(),function(){"use strict";function a(a,b){b.initialize().then(function(){a.deskLookup=b.deskLookup,a.userLookup=b.userLookup})}a.$inject=["$scope","desks"],angular.module("superdesk.authoring.metadata",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("metadata",{icon:"info",label:gettext("Info"),template:"scripts/superdesk-authoring/metadata/views/metadata-widget.html",order:1})}]).controller("MetadataWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c){var d=[];b.get("workqueue:items").then(function(a){d=a.items}),this.length=0,this.active=null,this.add=function(a){return _.remove(d,{_id:a._id}),d.unshift(a),this.length=d.length,this.active=a,this.save(),this},this.update=function(a){if(a){var b=this.find({_id:a._id});d[_.indexOf(d,b)]=_.extend(b,a),this.save()}},this.first=function(){return _.first(d)},this.all=function(){return d},this.save=function(){var a={"workqueue:items":{items:d}};b.update(a,"workqueue:items").then(function(){},function(){c.error(gettext("User preference could not be saved..."))})},this.find=function(a){return _.find(d,a)},this.setActive=function(a){this.active=a?this.find({_id:a._id}):null},this.getActive=function(){return this.active?this.active._id:null},this.remove=function(a){_.remove(d,{_id:a._id}),this.length=d.length,this.save(),this.active._id===a._id&&this.length>0?this.setActive(_.first(d)):this.active=null}}function b(a,b,c,d){a.workqueue=b.all(),a.content=new d,a.openItem=function(d){a.active&&a.update(),b.setActive(d),c.intent("author","article",d)},a.openDashboard=function(){c.intent("author","dashboard")},a.closeItem=function(d){a.active?a.close():(b.remove(d),c.intent("author","dashboard"))}}function c(){return{templateUrl:"scripts/superdesk-authoring/views/opened-articles.html",scope:{active:"=",update:"&",close:"&"},controller:b}}a.$inject=["storage","preferencesService","notify"],b.$inject=["$scope","workqueue","superdesk","ContentCtrl"],angular.module("superdesk.authoring.workqueue",["superdesk.activity"]).service("workqueue",a).directive("sdWorkqueue",c).config(["superdeskProvider",function(a){a.activity("/authoring/",{label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/views/dashboard.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",beta:!0,controller:b,category:a.MENU_MAIN,filters:[{action:"author",type:"dashboard"}]})}])}();