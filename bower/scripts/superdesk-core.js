"use strict";angular.module("superdesk.editor",[]).directive("sdTextEditor",function(){var a={buttons:["bold","italic","underline","quote"]};return{require:"ngModel",link:function(b,c,d,e){function f(){b.$apply(function(){e.$setViewValue(c.html())})}c.on("input",f),c.on("blur",f),e.$render=function(){c.empty(),c.html(e.$viewValue||"<p></p>"),this.editor=new window.MediumEditor(c,a)},b.$on("$destroy",function(){c.off("input"),c.off("blur")})}}}),function(){function a(a){var b=this;a.links().then(function(a){angular.extend(b,a)})}a.$inject=["urls"],angular.module("superdesk.features",["superdesk.api"]).service("features",a)}(),function(){return angular.module("superdesk.asset",[]).provider("asset",["$injector",function(a){this.templateUrl=function(b){var c=a.get("config"),d=b;return/^(https?:\/\/|\/\/|\/|.\/|..\/)/.test(b)||(d="scripts/"+d),!/^(https?:\/\/|\/\/)/.test(b)&&c.paths&&c.paths.superdesk&&(d=c.paths.superdesk+d),d=d.replace(/[^\/]+\/+\.\.\//g,"").replace(/\.\//g,"").replace(/(\w)\/\/(\w)/g,"$1/$2")},this.imageUrl=this.templateUrl,this.$get=function(){return this}}])}(),function(){angular.module("superdesk.menu",["superdesk.menu.notifications","superdesk.asset"]).directive("sdSuperdeskView",["asset",function(a){return{templateUrl:a.templateUrl("superdesk/menu/views/superdesk-view.html"),controller:function(){this.flags={menu:!1,notifications:!1}},link:function(a,b,c,d){a.flags=d.flags}}}]).directive("sdMenuWrapper",["$route","superdesk","betaService","userNotifications","asset",function(a,b,c,d,e){return{require:"^sdSuperdeskView",templateUrl:e.templateUrl("superdesk/menu/views/menu.html"),link:function(e,f,g,h){function i(a){_.each(e.menu,function(b){b.isActive=a&&a.href&&a.href.substr(0,b.href.length)===b.href})}e.currentRoute=null,e.flags=h.flags,e.$watch("beta",function(){e.menu=_.values(_.where(b.activities,{category:b.MENU_MAIN}))}),e.toggleMenu=function(){h.flags.menu=!h.flags.menu},e.toggleNotifications=function(){h.flags.notifications=!h.flags.notifications},e.toggleBeta=function(){c.toggleBeta()},e.$on("$locationChangeStart",function(){h.flags.menu=!1}),e.$watch(function(){return a.current},function(a){e.currentRoute=a||null,i(e.currentRoute)}),e.notifications=d}}}])}(),function(){function a(a,b,c,d){function e(){var a={},b="read."+d.identity._id||"all";return a[b]={$exists:!0},a}function f(a){var b=a._dest||{};return!b[d.identity._id]}var g=1e3,h=500;this._items=null,this.unread=0,this.reload=function(){if(!d.identity)return this._items=null,void(this.unread=0);var a={where:e(),embedded:{user:1,item:1},max_results:8};return c("activity").query(a).then(angular.bind(this,function(a){this._items=a._items,this.unread=0,_.each(this._items,function(a){try{a._unread=!a.read[d.identity._id],this.unread+=a._unread?1:0}catch(b){}},this)}))},this.markAsRead=function(a){var b=angular.extend({},a),e=a.read;return e[d.identity._id]=1,c("activity").save(b,{read:e}).then(angular.bind(this,function(){this.unread=_.max([0,this.unread-1]),a._unread=null}))};var i=angular.bind(this,this.reload);a.$on("activity",function(a,c){f(c)&&b(i,h)}),b(i,g)}function b(a,b){var c=5e3;return{link:function(d){if(d.notification._unread){var e=b(function(){a.markAsRead(d.notification)},c);d.$on("$destroy",function(){b.cancel(e)})}}}}a.$inject=["$rootScope","$timeout","api","session"],b.$inject=["userNotifications","$timeout"],angular.module("superdesk.menu.notifications",["superdesk.asset"]).service("userNotifications",a).directive("sdMarkAsRead",b).directive("sdNotifications",["asset",function(a){return{require:"^sdSuperdeskView",templateUrl:a.templateUrl("superdesk/menu/notifications/views/notifications.html"),link:function(a,b,c,d){a.flags=d.flags}}}])}(),function(){function a(a,b,c){return function(){this.create=function(){var d={type:"text"};a("archive").save(d).then(function(){c.add(d),b.intent("author","article",d)})}}}function b(a,b){return function(c){var d,e,f=a("content_view");this.flags={},this.views=null,this.selected=null,this.select=function(a){this.selected=a||null},this.edit=function(a){this.edited=_.create(a),d=a,this.flags={};try{this.flags.query=a.filter.query.filtered.query.query_string.query}catch(b){this.flags.query=null}this._issues=null},this.create=function(){this.edit({})},this.cancel=function(){this.edited=null},this.save=function(){this.flags.is_desk&&(this.edited.desk=e),this.edited.filter={query:{filtered:{query:{query_string:{query:this.flags.query||"*"}}}}},this.edited.location=this.edited.location||"archive",f.save(d,this.edited).then(angular.bind(this,function(){this.reload(),this.cancel()}),angular.bind(this,function(a){this._issues=a._issues}))},this.reload=function(){var a={};return a.where=e?{desk:e}:{user:b.identity._id},f.query(a).then(angular.bind(this,function(a){this.views=a._items}))},c.$watch("selectedDesk",angular.bind(this,function(a){e=a?a._id:null,this.select(),this.reload()}))}}function c(){return{templateUrl:"scripts/superdesk-workspace/content/views/desk-views.html"}}a.$inject=["api","superdesk","workqueue"],b.$inject=["api","session"],angular.module("superdesk.workspace.content",[]).factory("ViewsCtrl",b).factory("ContentCtrl",a).directive("sdDeskViews",c)}(),function(){function a(a,b,c){this.save=function(a,b){return b.task.due_time&&(b.task.due_date=new Date(b.task.due_date.getFullYear(),b.task.due_date.getMonth(),b.task.due_date.getDate(),b.task.due_time.getHours(),b.task.due_time.getMinutes(),b.task.due_time.getSeconds())),delete b.task.due_time,b.task.user||delete b.task.user,c("tasks").save(a,b).then(function(a){return a})},this.buildFilter=function(c){var d;return d=c?{term:{"task.stage":c._id}}:a.getCurrentDeskId()?{term:{"task.desk":a.getCurrentDeskId()}}:{term:{"task.user":b.currentUser._id}}},this.fetch=function(a){var b=this.buildFilter(a);return c("tasks").query({source:{size:25,sort:[{_updated:"desc"}],filter:b}})}}function b(a,b,c,d,e,f){function g(b){e.fetch(b).then(function(b){a.tasks=b})}a.selected={},a.newTask=null,a.tasks=null,a.stages=new f(a),a.$watch(function(){return d.getCurrentDeskId()},function(){g()}),a.preview=function(b){a.selected.preview=b},a.create=function(){a.newTask={task:{desk:d.getCurrentDeskId(),due_date:new Date((new Date).getTime()+864e5),due_time:new Date(null,null,null,12,0,0)}}},a.save=function(){e.save({},a.newTask).then(function(){c.success(gettext("Item saved.")),a.close(),g()})},a.close=function(){a.newTask=null},d.initialize().then(function(){a.userLookup=d.userLookup,a.deskLookup=d.deskLookup}),a.$watch("stages.selected",function(a,b){(a||b)&&g(a)})}function c(a,b,c){var d=b.initialize();return{templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/task-preview.html",scope:{item:"=",close:"&onclose"},link:function(e){var f;e.task=null,e.task_details=null,e.editmode=!1,d.then(function(){e.desks=b.deskLookup,e.users=b.userLookup}),e.$watch("item._id",function(a){a&&e.reset()}),e.save=function(){e.task.task=_.extend(e.task.task,e.task_details),a.save(f,e.task).then(function(){c.success(gettext("Item saved.")),e.editmode=!1})},e.edit=function(){e.editmode=!0},e.reset=function(){e.editmode=!1,e.task=_.create(e.item),e.task_details=_.extend({},e.item.task),e.task_details.due_date=new Date(e.item.task.due_date),e.task_details.due_time=new Date(e.item.task.due_date),f=e.item}}}}function d(a){var b=a.initialize();return{templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/assignee-view.html",scope:{task:"="},link:function(c){b.then(function(){var b=angular.extend({desk:null,user:null},c.task),d=a.deskLookup[b.desk]||{},e=a.userLookup[b.user]||{};c.deskName=d.name||null,c.userName=e.display_name||null,c.userPicture=e.picture_url||null})}}}function e(a,b){var c=b.initialize();return function(a){var d=this;c.then(function(){d.stages=null,d.selected=null,d.select=function(a){d.selected=a||null;var c=a?a._id:null;b.setCurrentStageId(c)},d.reload=function(a){d.stages=a?b.deskStages[a]:null,d.select(_.find(d.stages,{_id:b.getCurrentStageId()}))},a.$watch(function(){return b.getCurrentDeskId()},function(a){d.reload(a||null)})})}}function f(){return{templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/desk-stages.html"}}a.$inject=["desks","$rootScope","api"],b.$inject=["$scope","api","notify","desks","tasks","StagesCtrl"],c.$inject=["tasks","desks","notify"],d.$inject=["desks"],e.$inject=["api","desks"],angular.module("superdesk.workspace.tasks",[]).factory("StagesCtrl",e).directive("sdTaskPreview",c).directive("sdAssigneeView",d).directive("sdDeskStages",f).service("tasks",a).config(["superdeskProvider",function(a){a.activity("/workspace/tasks",{label:gettext("Workspace"),controller:b,templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/workspace-tasks.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",beta:!0}),a.activity("pick.task",{label:gettext("Pick task"),icon:"pick",controller:["data","superdesk",function(a,b){return b.intent("author","article",a.item)}],filters:[{action:a.ACTION_EDIT,type:"task"}]})}])}(),function(){function a(a,b){this.usernamePattern=/^[A-Za-z0-9_.'-]+$/,this.phonePattern=/^(?:(?:0?[1-9][0-9]{8})|(?:(?:\+|00)[1-9][0-9]{9,11}))$/,this.save=function(b,c){return a.save("users",b,c).then(function(a){return angular.extend(b,c),angular.extend(b,a),b})},this.changePassword=function(){return console.error("change password not implemented"),b.reject()},this.isActive=function(a){return a&&a.is_active},this.toggleStatus=function(a,b){return this.save(a,{is_active:b})}}function b(a,b,c){function d(a,b,c){return a+"_"+b+"_"+c}var e={},f=c("userList"),g="_nosearch",h=1,i=20;return e.get=function(c,e,j){e=e||h;var k=c||g;j=j||i,k=d(k,e,j);var l=f.get(k);if(l)return b.when(l);var m={max_results:j};return c&&(m.where=JSON.stringify({$or:[{username:{$regex:c,$options:"-i"}},{first_name:{$regex:c,$options:"-i"}},{last_name:{$regex:c,$options:"-i"}},{email:{$regex:c,$options:"-i"}}]})),a("users").query(m).then(function(a){return f.put(k,a),a})},e.getUser=function(c){var e=d(g,h),i=f.get(e);if(i){var j=_.find(i._items,{_id:c});if(j)return b.when(j)}return a("users").getById(c).then(function(a){return a})},e}function c(a,b,c){function d(a,b){return _.find(a,function(a){return a._links.self.href===b._links.self.href})}function e(){var c=b.search(),d={max_results:a.maxResults};return c.q&&(d.where=JSON.stringify({$or:[{username:{$regex:c.q,$options:"-i"}},{first_name:{$regex:c.q,$options:"-i"}},{last_name:{$regex:c.q,$options:"-i"}},{email:{$regex:c.q,$options:"-i"}}]})),c.page&&(d.page=parseInt(c.page,10)),d.sort=c.sort?g(c.sort[0],c.sort[1]):g("full_name","asc"),d}function f(b){c.users.query(b).then(function(b){a.users=b,a.createdUsers=[]})}function g(a,b){var c="asc"===b?1:-1;switch(a){case"full_name":return'[("first_name", '+c+'), ("last_name", '+c+")]";default:return'[("'+encodeURIComponent(a)+'", '+c+")]"}}a.maxResults=25,a.selected={user:null},a.createdUsers=[],a.preview=function(b){a.selected.user=b},a.createUser=function(){a.intent("create","user").then(f)},a.$on("intent:create:user",function(){a.preview({})}),a.closePreview=function(){a.preview(null)},a.afterDelete=function(b){a.selected.user&&b.item&&b.item.href===a.selected.user.href&&(a.selected.user=null),f(e())},a.render=function(b){d(a.users._items,b)||d(a.createdUsers,b)||a.createdUsers.unshift(b)},a.$watch(e,f,!0)}function d(a,b,c,d,e){a.user=d,a.profile=a.user._id===e.identity._id}function e(a,b,c,d,e){a.methods=[{id:"upload",label:gettext("Upload from computer")},{id:"camera",label:gettext("Take a picture"),beta:!0},{id:"web",label:gettext("Use a Web URL"),beta:!0}],e.isBeta().then(function(b){b||(a.methods=_.reject(a.methods,{beta:!0}))}),a.activate=function(b){a.active=b,a.preview={},a.progress={width:0}},a.activate(a.methods[0]),a.upload=function(c){var e={};if(e.CropLeft=Math.round(Math.min(c.cords.x,c.cords.x2)),e.CropRight=Math.round(Math.max(c.cords.x,c.cords.x2)),e.CropTop=Math.round(Math.min(c.cords.y,c.cords.y2)),e.CropBottom=Math.round(Math.max(c.cords.y,c.cords.y2)),c.img)e.media=c.img;else{if(!c.url)return;e.URL=c.url}return d.resource("upload").then(function(c){return b.start({url:c,method:"POST",data:e}).then(function(b){if("ERR"!==b.data._status){var c=b.data.renditions.viewImage.href;return a.locals.data.picture_url=c,a.locals.data.avatar=b.data._id,a.resolve(c)}},null,function(b){a.progress.width=Math.round(b.loaded/b.total*100)})})}}function f(a,b,c,d,e){return a.users.remove(b.item).then(function(){b.list.splice(b.index,1)},function(){d.error(e("I'm sorry but can't delete the user right now."))})}function g(a,b,c,d,e){return a.users.getById(b.current.params._id).then(null,function(a){return 404===a.status&&(e.path("/users/"),c.error(d("User was not found, sorry."),5e3)),a})}function h(a,b,c,d){function e(){return c.confirm(d("Are you sure you want to delete user role?"))}var f;a.selectedRole=null,a.editRole=null,b("roles").query().then(function(b){a.roles=b._items}),a.select=function(b){a.selectedRole=b},a.edit=function(b){a.editRole=_.create(b),f=b},a.save=function(c){var d=c._id?!1:!0;b("roles").save(f,c).then(function(){d&&a.roles.unshift(f),a.cancel()})},a.cancel=function(){a.editRole=null},a.remove=function(c){e().then(function(){b("roles").remove(c).then(function(){_.remove(a.roles,c)},function(a){console.log(a)})})}}return a.$inject=["api","$q"],b.$inject=["api","$q","$cacheFactory"],c.$inject=["$scope","$location","api"],d.$inject=["$scope","server","superdesk","user","session"],e.$inject=["$scope","upload","session","urls","betaService"],f.$inject=["api","data","$q","notify","gettext"],g.$inject=["api","$route","notify","gettext","$location"],h.$inject=["$scope","api","modal","gettext"],angular.module("superdesk.users",["superdesk.users.profile","superdesk.users.activity","superdesk.activity","superdesk.asset"]).service("users",a).factory("userList",b).factory("userPopup",["$compile","$timeout","userList",function(a,b,c){function d(){var a=i.get();a&&a.hide()}function e(){var a=i.get();a&&a.html("")}function f(){b.cancel(i.status)}function g(){i.status=b(d,j)}function h(b,c){var d=i.get();d.html('<div class="avatar-holder"><figure class="avatar big"><img sd-user-avatar data-src="user.picture_url"></figure></div><div class="title">{{user.display_name}}</div><div class="actions"><a href="#/users/{{user._id}}">go to profile</a></div>');var e=c.$new(!0);e.user=b,a(d)(e)}var i={},j=300;return i.get=function(a){return!i.element&&a&&(i.element=$('<div class="user-popup"></div>'),i.element.appendTo("BODY"),i.element.hover(f,g),i.element.click(d)),i.element},i.set=function(a,b,d){f(),e();var g=i.get(!0),j=b.offset();g.css({left:j.left+b.outerWidth(),top:j.top+b.outerHeight()}),c.getUser(a).then(function(a){h(a,d)},function(a){console.log(a)}),g.show()},i.close=function(){var a=i.get();a&&g()},i}]).config(["superdeskProvider",function(a){a.permission("users-manage",{label:gettext("Manage users"),permissions:{users:{write:!0}}}).permission("users-read",{label:gettext("Read users"),permissions:{users:{read:!0}}}).permission("user-roles-manage",{label:gettext("Manage user roles"),permissions:{user_roles:{write:!0}}}).permission("user-roles-read",{label:gettext("Read user roles"),permissions:{user_roles:{read:!0}}})}]).config(["superdeskProvider","assetProvider",function(a,b){a.activity("/users/",{label:gettext("Users"),priority:100,controller:c,templateUrl:b.templateUrl("superdesk-users/views/list.html"),category:a.MENU_MAIN,reloadOnSearch:!1,filters:[{action:a.ACTION_PREVIEW,type:"user"},{action:"list",type:"user"}]}).activity("/users/:_id",{label:gettext("Users profile"),priority:100,controller:d,templateUrl:b.templateUrl("superdesk-users/views/edit.html"),resolve:{user:g},filters:[{action:"detail",type:"user"}]}).activity("/profile/",{label:gettext("My Profile"),controller:d,templateUrl:b.templateUrl("superdesk-users/views/edit.html"),resolve:{user:["session","api",function(a,b){return b.users.getByUrl(a.identity._links.self.href)}]}}).activity("/settings/user-roles",{label:gettext("User Roles"),templateUrl:b.templateUrl("superdesk-users/views/settings.html"),controller:h,category:a.MENU_SETTINGS,priority:-500}).activity("delete/user",{label:gettext("Delete user"),icon:"trash",confirm:gettext("Please confirm you want to delete a user."),controller:f,filters:[{action:a.ACTION_EDIT,type:"user"}]}).activity("edit.avatar",{label:gettext("Change avatar"),modal:!0,cssClass:"upload-avatar",controller:e,templateUrl:b.templateUrl("superdesk-users/views/change-avatar.html"),filters:[{action:"edit",type:"avatar"}]})}]).config(["apiProvider",function(a){a.api("users",{type:"http",backend:{rel:"users"}}),a.api("roles",{type:"http",backend:{rel:"roles"}})}]).config(["$compileProvider",function(a){a.directive("compile",["$compile",function(a){return function(b,c,d){var e=b.$eval(d.compile);c.html(e);var f=b.$new(!0);_.each(b.$eval(d.data),function(a,b){f[b]=a}),a(c.contents())(f)}}])}]).directive("sdInfoItem",function(){return{link:function(a,b){b.addClass("item"),b.find("input").addClass("info-value"),b.find("input").addClass("info-editable")}}}).directive("sdValidError",function(){return{link:function(a,b){b.addClass("validation-error")}}}).directive("sdValidInfo",function(){return{link:function(a,b){b.addClass("validation-info")}}}).directive("sdUserActivity",["profileService","asset",function(a,b){return{restrict:"A",replace:!0,templateUrl:b.templateUrl("superdesk-users/views/activity-feed.html"),scope:{user:"="},link:function(b){var c=1,d=5;b.$watch("user",function(){a.getUserActivity(b.user,d).then(function(a){b.activityFeed=a})}),b.loadMore=function(){c++,a.getUserActivity(b.user,d,c).then(function(a){Array.prototype.push.apply(b.activityFeed._items,a._items),b.activityFeed._links=a._links})}}}}]).directive("sdUserDetailsPane",["$timeout",function(a){return{replace:!0,transclude:!0,template:'<div class="user-details-pane" ng-transclude></div>',link:function(b){a(function(){$(".user-details-pane").addClass("open")}),b.closePane=function(){$(".user-details-pane").removeClass("open")}}}}]).directive("sdUserEdit",["gettext","notify","users","session","$location","$route","superdesk","features","asset",function(a,b,c,d,e,f,g,h,i){return{templateUrl:i.templateUrl("superdesk-users/views/edit-form.html"),scope:{origUser:"=user",onsave:"&",oncancel:"&",onupdate:"&"},link:function(i){function j(a){i.error=null,i.user=_.create(a),i.confirm={password:null},i.show={password:!1},i._active=c.isActive(a)}i.features=h,i.usernamePattern=c.usernamePattern,i.phonePattern=c.phonePattern,i.dirty=!1,i.$watch("origUser",j),i.$watchCollection("user",function(a){_.each(a,function(b,c){""===b&&delete a[c]}),i.dirty=!angular.equals(a,i.origUser)}),i.cancel=function(){j(i.origUser),i.origUser.Id||i.oncancel()},i.editPicture=function(){g.intent("edit","avatar",i.user).then(function(a){i.user.picture_url=a})},i.save=function(){return i.error=null,b.info(a("saving..")),c.save(i.origUser,i.user).then(function(){j(i.origUser),b.pop(),b.success(a("user saved.")),i.onsave({user:i.origUser}),i.user._id===d.identity._id&&d.updateIdentity(i.user)},function(c){if(b.pop(),404===c.status)"/users/"===e.path()?f.reload():e.path("/users/"),b.error(a("User is not found. It might be deleted."));else{if(c.data&&c.data._issues){i.error=c.data._issues;for(var d in c.data._issues)if(i.userForm[d])for(var g in c.data._issues[d])c.data._issues[d][g]&&i.userForm[d].$setValidity(g,!1)}b.error(a("Hmm, there was an error when saving user. "))}})},i.toggleStatus=function(a){c.toggleStatus(i.origUser,a).then(function(){j(i.origUser),i.onupdate({user:i.origUser})})}}}}]).directive("sdUserPreferences",["api","session","preferencesService","notify","asset",function(a,b,c,d,e){return{templateUrl:e.templateUrl("superdesk-users/views/user-preferences.html"),link:function(a){function b(b){a.preferences={},_.each(b,function(b,c){a.preferences[c]=_.create(b)})}function e(){var b={};return _.each(f,function(c,d){b[d]=_.extend(c,a.preferences[d])}),b}var f;c.get().then(function(a){f=a,b(f)}),a.cancel=function(){a.userPrefs.$setPristine(),b(f)},a.save=function(){var b=e();c.update(b).then(function(){a.cancel()},function(){d.error(gettext("User preferences could not be saved..."))})}}}}]).directive("sdChangePassword",["api","notify","gettext",function(a,b,c){return{link:function(d){d.$watch("user",function(){d.oldPasswordInvalid=!1}),d.changePassword=function(e,f){return a.users.changePassword(d.user,e,f).then(function(){d.oldPasswordInvalid=!1,b.success(c("New password is saved now."),3e3),d.show.password=!1},function(){d.oldPasswordInvalid=!0})}}}}]).directive("sdUserUnique",["$q","api",function(a,b){return{require:"ngModel",scope:{exclude:"="},link:function(c,d,e,f){function g(d,f){var g=d||f;if(g&&e.uniqueField){var h={where:{}};return h.where[e.uniqueField]=g,b.users.query(h).then(function(b){return!b._items.length||c.exclude._id&&b._items[0]._id===c.exclude._id?b:a.reject(b)})}return a.when()}f.$asyncValidators.unique=g}}}]).directive("sdPasswordConfirm",[function(){var a="confirm";return{require:"ngModel",scope:{password:"="},link:function(b,c,d,e){function f(a,b){return!a||a===b}e.$validators[a]=function(a,c){var d=a||c;return f(b.password,d)},b.$watch("password",function(b){e.$setValidity(a,f(b,e.$viewValue))})}}}]).directive("sdUserList",["keyboardManager","users","asset",function(a,b,c){return{templateUrl:c.templateUrl("superdesk-users/views/user-list-item.html"),scope:{users:"=",selected:"=",done:"="},link:function(c){function d(){return _.findIndex(c.users,c.selected)}c.active=function(a){return b.isActive(a)},c.select=function(a){c.selected=a},c.$watch("users",function(){}),a.bind("up",function(){var a=d();-1!==a&&c.select(c.users[_.max([0,a-1])])}),a.bind("down",function(){var a=d();-1!==a&&c.select(c.users[_.min([c.users.length-1,a+1])])})}}}]).directive("sdUserListItem",["asset",function(a){return{templateUrl:a.templateUrl("superdesk-users/views/user-list-item.html")}}]).directive("sdActivity",["asset",function(a){return{templateUrl:a.templateUrl("superdesk-users/views/activity-list.html")}}]).directive("sdUserMentio",["mentioUtil","api","userList","asset",function(a,b,c,d){return{templateUrl:d.templateUrl("superdesk-users/views/mentions.html"),link:function(a){a.users=[],a.searchUsers=function(b){return c.get(b,1,10).then(function(b){a.users=_.sortBy(b._items,"username")})},a.selectUser=function(a){return"@"+a.username}}}}]).directive("sdUserInfo",["userPopup",function(a){return{link:function(b,c,d){c.addClass("user-link"),c.hover(function(){a.set(d.user,c,b)},function(){a.close()})}}}])}(),function(){angular.module("superdesk.users.profile",["superdesk.api"]).config(["apiProvider",function(a){a.api("activity",{type:"http",backend:{rel:"activity"}})}]).service("profileService",["api",function(a){return{getUserActivity:function(b,c,d){var e={where:{user:b._id},sort:"[('_created',-1)]",embedded:{user:1}};return c&&(e.max_results=c),d>1&&(e.page=d),a.activity.query(e)},getUserActivityFiltered:function(b,c){var d={sort:"[('_created',-1)]",embedded:{user:1}};return b&&(d.max_results=b),c>1&&(d.page=c),a.activity.query(d)}}}])}(),function(){angular.module("superdesk.users.activity",["superdesk.dashboard.widgets","superdesk.asset"]).config(["widgetsProvider","assetProvider",function(a,b){a.widget("activity",{label:"Activity Log",multiple:!0,max_sizex:2,max_sizey:2,sizex:1,sizey:2,thumbnail:b.imageUrl("superdesk-users/activity/thumbnail.png"),template:b.templateUrl("superdesk-users/activity/widget-activity.html"),configurationTemplate:b.templateUrl("superdesk-users/activity/configuration.html"),configuration:{maxItems:5},description:"Activity log widget"})}]).controller("ActivityController",["$scope","profileService",function(a,b){function c(c){e=c,b.getUserActivityFiltered(c.maxItems).then(function(b){a.activityFeed=b}),a.loadMore=function(){d++,b.getUserActivityFiltered(c.maxItems,d).then(function(b){Array.prototype.push.apply(a.activityFeed._items,b._items),a.activityFeed._links=b._links})}}var d=1,e=null;a.$on("changes in activity",function(){e&&c(e)}),a.$watch("widget.configuration",function(a){d=1,a&&c(a)},!0)}]).controller("ActivityConfigController",["$scope",function(a){a.notIn=function(a){return function(b){return-1===a.indexOf(b)}}}])}(),function(){function a(a,b){function c(a){var c={};return c[a]=1,b.reject(c)}this.importUser=function(b){return a.save("import_profile",b).then(null,function(a){return c(404===a.status?"profile_to_import":"credentials")})}}function b(a,b){a.model={},a.error=null,a.importUser=function(c){a.error=null,b.importUser(c).then(function(b){a.resolve(b)},function(b){a.error=b})}}angular.module("superdesk.users.import",["superdesk.activity","superdesk.api"]).service("userImport",a).config(["superdeskProvider",function(a){a.activity("import.user",{label:gettext("Import user"),modal:!0,controller:b,templateUrl:"scripts/superdesk-users/import/views/import-user.html",filters:[{action:"create",type:"user"}],features:{import_profile:1}})}])}(),function(){function a(a,b,c,d,e,f){a.modalActive=!1,a.step={current:null},a.group={edit:null},a.groups={},e.initialize().then(function(){a.groups=e.groups}),a.openGroup=function(b,c){a.group.edit=c,a.modalActive=!0,f.wizard("usergroups").goTo(b)},a.cancel=function(){a.modalActive=!1,a.step.current=null,a.group.edit=null},a.remove=function(e){d.groups.remove(e).then(function(){_.remove(a.groups._items,e),c.success(b("Group deleted."),3e3)})}}function b(a,b,c){return{link:function(d){d.$watch("step.current",function(a){"general"===a&&(d.edit(d.group.edit),d.message=null)}),d.edit=function(a){d.group.edit=_.create(a)},d.save=function(e){d.message=a("Saving...");var f=e._id?!1:!0;b.groups.save(d.group.edit,e).then(function(){if(f)d.edit(d.group.edit),d.groups._items.unshift(d.group.edit);else{var a=_.find(d.groups._items,{_id:d.group.edit._id});_.extend(a,d.group.edit)}c.wizard("usergroups").next()},function(){d.message=a("There was a problem, group not created/updated.")})}}}}function c(a,b,c,d){return{link:function(e){function f(){e.membersToSelect=_.difference(e.users,e.groupMembers)}e.$watch("step.current",function(a,b){"people"===a&&(e.search=null,e.groupMembers=[],e.users=[],e.membersToSelect=[],e.message=null,e.group.edit&&e.group.edit._id?d.initialize().then(function(){e.groupMembers=d.groupMembers[e.group.edit._id]||[],e.users=d.users._items,f()}):c.wizard("usergroups").goTo(b))}),e.add=function(a){e.groupMembers.push(a),f(),e.search=null},e.remove=function(a){_.remove(e.groupMembers,a),f()},e.previous=function(){c.wizard("usergroups").previous()},e.save=function(){var f=_.map(e.groupMembers,function(a){return{user:a._id}});b.groups.save(e.group.edit,{members:f}).then(function(a){_.extend(e.group.edit,a),d.groupMembers[e.group.edit._id]=e.groupMembers;var b=_.find(d.groups._items,{_id:e.group.edit._id});_.extend(b,e.group.edit),c.wizard("usergroups").finish()},function(){e.message=a("There was a problem, members not saved.")})}}}}var d=angular.module("superdesk.groups",["superdesk.users"]);return d.config(["superdeskProvider",function(b){b.activity("/settings/groups",{label:gettext("Groups"),controller:a,templateUrl:"scripts/superdesk-groups/views/settings.html",category:b.MENU_SETTINGS,priority:-800,beta:!0})}]).config(["apiProvider",function(a){a.api("groups",{type:"http",backend:{rel:"groups"}})}]).factory("groups",["$q","api","storage","userList",function(a,b,c,d){var e={groups:null,users:null,groupLookup:{},userLookup:{},groupMembers:{},loading:null,fetchGroups:function(){var a=this;return b.groups.query({max_results:500}).then(function(b){a.groups=b,_.each(b._items,function(b){a.groupLookup[b._id]=b})})},fetchUsers:function(){var a=this;return d.get(null,1,500).then(function(b){a.users=b,_.each(b._items,function(b){a.userLookup[b._id]=b})})},generateGroupMembers:function(){var b=this;return _.each(this.groups._items,function(a){b.groupMembers[a._id]=[],_.each(a.members,function(c){var d=_.find(b.users._items,{_id:c.user});d&&b.groupMembers[a._id].push(d)})}),a.when()},fetchUserGroups:function(a){return b.users.getByUrl(a._links.self.href+"/groups")},getCurrentGroupId:function(){return c.getItem("groups:currentGroupId")||null},setCurrentGroupId:function(a){c.setItem("groups:currentGroupId",a)},fetchCurrentGroup:function(){return b.groups.getById(this.getCurrentGroupId())},setCurrentGroup:function(a){this.setCurrentGroupId(a?a._id:null)},getCurrentGroup:function(){return this.groupLookup[this.getCurrentGroupId()]},initialize:function(){return this.loading||(this.loading=this.fetchGroups().then(angular.bind(this,this.fetchUsers)).then(angular.bind(this,this.generateGroupMembers))),this.loading}};return e}]).directive("sdGroupeditBasic",b).directive("sdGroupeditPeople",c),a.$inject=["$scope","gettext","notify","api","groups","WizardHandler"],b.$inject=["gettext","api","WizardHandler"],c.$inject=["gettext","api","WizardHandler","groups"],d}();